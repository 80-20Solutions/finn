name: Build & Deploy APK

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    name: Build APK & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Extract version & branch info
        id: info
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BRANCH="${{ github.head_ref || github.ref_name }}"
          SLUG=$(echo "$BRANCH" | sed 's|/|-|g' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
          SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          PR_NUM="${{ github.event.pull_request.number }}"

          if [ "$BRANCH" = "master" ] || [ "$BRANCH" = "main" ]; then
            APK_NAME="finn-v${VERSION}.apk"
            DEST="downloads"
            IS_PROD="true"
          elif [ -n "$PR_NUM" ]; then
            APK_NAME="finn-pr${PR_NUM}-${SHORT}.apk"
            DEST="downloads/test"
            IS_PROD="false"
          else
            APK_NAME="finn-${SLUG}-${SHORT}.apk"
            DEST="downloads/test"
            IS_PROD="false"
          fi

          echo "version=$VERSION"     >> $GITHUB_OUTPUT
          echo "branch=$BRANCH"       >> $GITHUB_OUTPUT
          echo "slug=$SLUG"           >> $GITHUB_OUTPUT
          echo "short=$SHORT"         >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME"   >> $GITHUB_OUTPUT
          echo "dest=$DEST"           >> $GITHUB_OUTPUT
          echo "is_prod=$IS_PROD"     >> $GITHUB_OUTPUT
          echo "url=https://apps.8020solutions.org/${DEST}/${APK_NAME}" >> $GITHUB_OUTPUT

      - name: Build APK
        run: flutter build apk --release

      - name: Rename APK
        run: |
          cp build/app/outputs/flutter-apk/app-release.apk \
             ${{ steps.info.outputs.apk_name }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy APK to app-hub
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "mkdir -p /var/www/app-hub/${{ steps.info.outputs.dest }}"
          rsync -avz \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ${{ steps.info.outputs.apk_name }} \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/app-hub/${{ steps.info.outputs.dest }}/

      # Su master: aggiorna anche symlink latest e crea GitHub Release
      - name: Update latest symlink (master only)
        if: steps.info.outputs.is_prod == 'true'
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd /var/www/app-hub/downloads && \
             ln -sf ${{ steps.info.outputs.apk_name }} finn-latest.apk && \
             echo 'Symlink aggiornato ‚Üí ${{ steps.info.outputs.apk_name }}'"

      - name: Create GitHub Release (master only)
        if: steps.info.outputs.is_prod == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.info.outputs.version }}
          name: Finn v${{ steps.info.outputs.version }}
          files: ${{ steps.info.outputs.apk_name }}
          make_latest: true
          body: |
            üöÄ Build automatica da CI
            Commit: ${{ github.sha }}
            üì≤ Download diretto: ${{ steps.info.outputs.url }}

      - name: Comment PR with APK link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üì≤ **APK di test pronto!**\n\nüîó [Scarica Finn APK](${{ steps.info.outputs.url }})\n\nCommit: \`${{ steps.info.outputs.short }}\``
            })

      - name: Notify Ciccio
        if: always()
        run: |
          EMOJI=$([ "${{ job.status }}" = "success" ] && echo "‚úÖ" || echo "‚ùå")
          URL="${{ steps.info.outputs.url }}"
          BRANCH="${{ steps.info.outputs.branch }}"
          SHORT="${{ steps.info.outputs.short }}"
          PR="${{ github.event.pull_request.number }}"
          PR_NOTE=$([ -n "$PR" ] && echo " (PR #${PR})" || echo "")

          if [ "${{ job.status }}" = "success" ]; then
            MSG="${EMOJI} Finn${PR_NOTE} ‚Äî ${BRANCH} (${SHORT})\nüì≤ APK pronto: ${URL}"
          else
            MSG="${EMOJI} Finn${PR_NOTE} ‚Äî build fallita\nBranch: ${BRANCH} (${SHORT})"
          fi

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "ciccio-notify '${MSG}'" \
            || true
